<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Landmark Calibration Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background:#0a0a0a; color:#f5f5f0; font-family: monospace; }
        .wrap { max-width:900px; margin:0 auto; padding:20px; }
        h1 { color:#c9a84c; font-size:1.4rem; margin-bottom:6px; }
        p { color:#666; font-size:.85rem; margin-bottom:16px; }
        .main { display:grid; grid-template-columns:1fr 340px; gap:20px; }
        .video-wrap { position:relative; background:#000; border-radius:12px; overflow:hidden; }
        video { width:100%; display:block; transform:scaleX(-1); }
        canvas { position:absolute; inset:0; width:100%; height:100%; }
        .panel { background:#141414; border-radius:12px; padding:16px; border:1px solid rgba(201,168,76,.2); overflow-y:auto; max-height:600px; }
        .panel h3 { color:#c9a84c; font-size:.9rem; margin-bottom:12px; letter-spacing:.05em; }
        .highlight-row { display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border-radius:6px; margin:4px 0; cursor:pointer; transition:background .2s; font-size:.8rem; }
        .highlight-row:hover { background:#1e1e1e; }
        .highlight-row.active { background:#1a1a00; border:1px solid #c9a84c; }
        .dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
        .coords { color:#555; font-size:.72rem; }
        .section { margin-bottom:16px; }
        .section-label { font-size:.7rem; letter-spacing:.1em; text-transform:uppercase; color:#444; margin-bottom:8px; border-bottom:1px solid #222; padding-bottom:4px; }
        .btn { background:#c9a84c; color:#000; border:none; padding:10px 18px; border-radius:8px; font-family:monospace; font-size:.85rem; font-weight:700; cursor:pointer; width:100%; margin-top:8px; }
        .btn:hover { background:#e8cc7a; }
        .btn-ghost { background:transparent; color:#c9a84c; border:1px solid #c9a84c; margin-top:6px; }
        .output { background:#0d0d0d; border-radius:8px; padding:12px; margin-top:12px; font-size:.72rem; color:#22c55e; line-height:1.8; white-space:pre-wrap; word-break:break-all; }
        .mode-btns { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
        .mode-btn { padding:6px 12px; border-radius:20px; font-size:.75rem; font-family:monospace; cursor:pointer; border:1px solid #333; background:transparent; color:#888; transition:all .2s; }
        .mode-btn.active { background:#c9a84c; color:#000; border-color:#c9a84c; font-weight:700; }
        .tip { background:#111; border-left:3px solid #c9a84c; padding:10px 12px; font-size:.78rem; color:#888; line-height:1.6; margin-bottom:12px; border-radius:0 6px 6px 0; }
        #status { font-size:.75rem; padding:4px 10px; border-radius:20px; display:inline-block; margin-bottom:10px; }
        #status.found { background:rgba(34,197,94,.15); color:#22c55e; border:1px solid #22c55e; }
        #status.searching { background:rgba(239,68,68,.15); color:#ef4444; border:1px solid #ef4444; }
    </style>
</head>
<body>
<div class="wrap">
    <h1>üéØ Landmark Calibration Tool</h1>
    <p>Shows all 468 MediaPipe face landmarks. Hover over points to see their numbers. Use this to find which landmarks match your beard lines.</p>

    <div id="status" class="searching">‚ü≥ Looking for face...</div>

    <div class="mode-btns">
        <button class="mode-btn active" onclick="setMode('all')" id="btn-all">All 468 Points</button>
        <button class="mode-btn" onclick="setMode('jaw')" id="btn-jaw">Jawline Only</button>
        <button class="mode-btn" onclick="setMode('cheek')" id="btn-cheek">Cheek Area</button>
        <button class="mode-btn" onclick="setMode('key')" id="btn-key">Key Points Only</button>
        <button class="mode-btn" onclick="setMode('numbers')" id="btn-numbers">Show Numbers</button>
    </div>

    <div class="main">
        <div>
            <div class="video-wrap">
                <video id="vid" autoplay playsinline muted></video>
                <canvas id="cv"></canvas>
            </div>
            <p style="font-size:.75rem;color:#444;margin-top:8px;text-align:center">
                Hover mouse over a point to see its landmark number below
            </p>
        </div>

        <div class="panel">
            <h3>HOVERED POINT</h3>
            <div id="hovered-info" style="padding:10px;background:#0d0d0d;border-radius:8px;margin-bottom:16px;font-size:.8rem;">
                <div style="color:#555">Move mouse over face to inspect points</div>
            </div>

            <div class="section">
                <div class="section-label">Key Beard Landmarks</div>
                <div class="tip">These are the most relevant points for beard line placement. Click any to highlight it on your face.</div>

                <div id="key-points">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="section">
                <div class="section-label">Your Selections</div>
                <div class="tip">Hover over the correct landmark for each line and click "Set" below</div>

                <div id="selections">
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #1a1a1a">
                        <span style="color:#3b82f6;font-size:.8rem">‚óè Cheek Line Start</span>
                        <span id="sel-cheekStart" style="color:#555;font-size:.75rem">not set</span>
                        <button onclick="setSelection('cheekStart')" style="background:#1a1a1a;color:#c9a84c;border:1px solid #333;padding:3px 8px;border-radius:4px;font-size:.7rem;cursor:pointer">Set</button>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #1a1a1a">
                        <span style="color:#3b82f6;font-size:.8rem">‚óè Cheek Line End</span>
                        <span id="sel-cheekEnd" style="color:#555;font-size:.75rem">not set</span>
                        <button onclick="setSelection('cheekEnd')" style="background:#1a1a1a;color:#c9a84c;border:1px solid #333;padding:3px 8px;border-radius:4px;font-size:.7rem;cursor:pointer">Set</button>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #1a1a1a">
                        <span style="color:#ef4444;font-size:.8rem">‚óè Ear Line Top</span>
                        <span id="sel-earTop" style="color:#555;font-size:.75rem">not set</span>
                        <button onclick="setSelection('earTop')" style="background:#1a1a1a;color:#c9a84c;border:1px solid #333;padding:3px 8px;border-radius:4px;font-size:.7rem;cursor:pointer">Set</button>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #1a1a1a">
                        <span style="color:#ef4444;font-size:.8rem">‚óè Ear Line Bottom</span>
                        <span id="sel-earBottom" style="color:#555;font-size:.75rem">not set</span>
                        <button onclick="setSelection('earBottom')" style="background:#1a1a1a;color:#c9a84c;border:1px solid #333;padding:3px 8px;border-radius:4px;font-size:.7rem;cursor:pointer">Set</button>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;">
                        <span style="color:#22c55e;font-size:.8rem">‚óè Neck Line Ref</span>
                        <span id="sel-neckRef" style="color:#555;font-size:.75rem">not set</span>
                        <button onclick="setSelection('neckRef')" style="background:#1a1a1a;color:#c9a84c;border:1px solid #333;padding:3px 8px;border-radius:4px;font-size:.7rem;cursor:pointer">Set</button>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="generateOutput()">Generate Ratios ‚Üí</button>
            <button class="btn btn-ghost" onclick="resetSelections()">Reset</button>

            <div id="output" class="output" style="display:none"></div>
        </div>
    </div>
</div>

<script>
// Key landmarks relevant to beard area
const KEY_POINTS = [
    // Jawline
    { id:10,   label:'Forehead top',      color:'#888' },
    { id:152,  label:'Chin bottom',        color:'#c9a84c' },
    { id:234,  label:'Left cheek edge',    color:'#3b82f6' },
    { id:454,  label:'Right cheek edge',   color:'#3b82f6' },
    { id:172,  label:'Left lower jaw',     color:'#3b82f6' },
    { id:397,  label:'Right lower jaw',    color:'#3b82f6' },
    { id:132,  label:'Left jawline',       color:'#3b82f6' },
    { id:361,  label:'Right jawline',      color:'#3b82f6' },
    { id:127,  label:'Left sideburn area', color:'#ef4444' },
    { id:356,  label:'Right sideburn area',color:'#ef4444' },
    { id:93,   label:'Left jaw lower',     color:'#c9a84c' },
    { id:323,  label:'Right jaw lower',    color:'#c9a84c' },
    { id:58,   label:'Left chin side',     color:'#22c55e' },
    { id:288,  label:'Right chin side',    color:'#22c55e' },
    { id:136,  label:'Left jaw mid',       color:'#a855f7' },
    { id:365,  label:'Right jaw mid',      color:'#a855f7' },
    { id:149,  label:'Left jaw lower2',    color:'#f97316' },
    { id:378,  label:'Right jaw lower2',   color:'#f97316' },
    { id:176,  label:'Left lowest jaw',    color:'#ec4899' },
    { id:400,  label:'Right lowest jaw',   color:'#ec4899' },
    // Ear area
    { id:234,  label:'Left ear front',     color:'#ef4444' },
    { id:454,  label:'Right ear front',    color:'#ef4444' },
    { id:227,  label:'Left ear top',       color:'#ef4444' },
    { id:447,  label:'Right ear top',      color:'#ef4444' },
    // Cheek
    { id:116,  label:'Left cheek low',     color:'#3b82f6' },
    { id:345,  label:'Right cheek low',    color:'#3b82f6' },
    { id:123,  label:'Left cheek mid',     color:'#3b82f6' },
    { id:352,  label:'Right cheek mid',    color:'#3b82f6' },
];

let mode = 'all';
let landmarks = null;
let hoveredIdx = null;
let selections = { cheekStart: null, cheekEnd: null, earTop: null, earBottom: null, neckRef: null };
let highlightedPoint = null;

function setMode(m) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + m).classList.add('active');
}

// Populate key points panel
function populateKeyPoints() {
    const container = document.getElementById('key-points');
    const unique = KEY_POINTS.filter((p, i, arr) => arr.findIndex(x => x.id === p.id) === i);
    container.innerHTML = unique.map(p => `
        <div class="highlight-row" onclick="highlightPoint(${p.id})" id="kp-${p.id}">
            <div style="display:flex;align-items:center;gap:6px">
                <div class="dot" style="background:${p.color}"></div>
                <span style="color:#ccc">#${p.id}</span>
            </div>
            <span style="color:#555;font-size:.72rem">${p.label}</span>
            <span class="coords" id="coord-${p.id}">‚Äî</span>
        </div>
    `).join('');
}

function highlightPoint(idx) {
    highlightedPoint = highlightedPoint === idx ? null : idx;
    document.querySelectorAll('.highlight-row').forEach(r => r.classList.remove('active'));
    if (highlightedPoint !== null) {
        const el = document.getElementById(`kp-${highlightedPoint}`);
        if (el) el.classList.add('active');
    }
}

function setSelection(key) {
    if (hoveredIdx === null) return;
    selections[key] = { idx: hoveredIdx, lm: landmarks ? landmarks[hoveredIdx] : null };
    document.getElementById(`sel-${key}`).textContent = `#${hoveredIdx}`;
    document.getElementById(`sel-${key}`).style.color = '#c9a84c';
}

function resetSelections() {
    selections = { cheekStart: null, cheekEnd: null, earTop: null, earBottom: null, neckRef: null };
    Object.keys(selections).forEach(k => {
        document.getElementById(`sel-${k}`).textContent = 'not set';
        document.getElementById(`sel-${k}`).style.color = '#555';
    });
    document.getElementById('output').style.display = 'none';
}

function generateOutput() {
    if (!landmarks) { alert('No face detected!'); return; }
    const faceTop    = landmarks[10].y;
    const faceBottom = landmarks[152].y;
    const faceLeft   = landmarks[234].x;
    const faceRight  = landmarks[454].x;
    const faceH = faceBottom - faceTop;
    const faceW = faceRight - faceLeft;

    const ratio = (lm, axis) => {
        if (!lm) return 'NOT SET';
        if (axis === 'x') return (((lm.x || 0) - faceLeft) / faceW * 100).toFixed(1) + '% of face width';
        if (axis === 'y') return (((lm.y || 0) - faceTop)  / faceH * 100).toFixed(1) + '% of face height';
    };

    const out = `// CALIBRATION OUTPUT
// Face anchors: top=#10, bottom=#152, left=#234, right=#454

cheekStart: landmark #${selections.cheekStart?.idx || '?'}
  x-ratio: ${selections.cheekStart ? ratio(selections.cheekStart.lm, 'x') : 'NOT SET'}
  y-ratio: ${selections.cheekStart ? ratio(selections.cheekStart.lm, 'y') : 'NOT SET'}

cheekEnd: landmark #${selections.cheekEnd?.idx || '?'}
  x-ratio: ${selections.cheekEnd ? ratio(selections.cheekEnd.lm, 'x') : 'NOT SET'}
  y-ratio: ${selections.cheekEnd ? ratio(selections.cheekEnd.lm, 'y') : 'NOT SET'}

earTop: landmark #${selections.earTop?.idx || '?'}
  x-ratio: ${selections.earTop ? ratio(selections.earTop.lm, 'x') : 'NOT SET'}
  y-ratio: ${selections.earTop ? ratio(selections.earTop.lm, 'y') : 'NOT SET'}

earBottom: landmark #${selections.earBottom?.idx || '?'}
  x-ratio: ${selections.earBottom ? ratio(selections.earBottom.lm, 'x') : 'NOT SET'}
  y-ratio: ${selections.earBottom ? ratio(selections.earBottom.lm, 'y') : 'NOT SET'}

neckRef: landmark #${selections.neckRef?.idx || '?'}
  (neck line sits BELOW this point)
  x-ratio: ${selections.neckRef ? ratio(selections.neckRef.lm, 'x') : 'NOT SET'}
  y-ratio: ${selections.neckRef ? ratio(selections.neckRef.lm, 'y') : 'NOT SET'}

// PASTE THIS BACK TO CLAUDE`;

    const el = document.getElementById('output');
    el.textContent = out;
    el.style.display = 'block';
}

// ‚îÄ‚îÄ‚îÄ Canvas Drawing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const video = document.getElementById('vid');
const canvas = document.getElementById('cv');
const ctx = canvas.getContext('2d');

// Track mouse hover
canvas.addEventListener('mousemove', (e) => {
    if (!landmarks) return;
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
    const my = (e.clientY - rect.top)  * (canvas.height / rect.height);
    const W = canvas.width, H = canvas.height;

    let closest = null, closestDist = 999;
    landmarks.forEach((lm, i) => {
        const x = (1 - lm.x) * W;
        const y = lm.y * H;
        const d = Math.sqrt((mx-x)**2 + (my-y)**2);
        if (d < closestDist) { closestDist = d; closest = i; }
    });

    if (closestDist < 20) {
        hoveredIdx = closest;
        const lm = landmarks[closest];
        const kp = KEY_POINTS.find(p => p.id === closest);
        document.getElementById('hovered-info').innerHTML = `
            <div style="color:#c9a84c;font-size:1rem;font-weight:700;margin-bottom:4px">Point #${closest}</div>
            <div style="color:#888;font-size:.78rem">${kp ? kp.label : 'Unnamed point'}</div>
            <div style="color:#555;font-size:.72rem;margin-top:4px">
                x: ${(lm.x*100).toFixed(1)}%  y: ${(lm.y*100).toFixed(1)}%
            </div>
            <div style="color:#444;font-size:.7rem;margin-top:2px">Click "Set" in selections panel to assign</div>
        `;

        // Update coord display for key points
        const coord = document.getElementById(`coord-${closest}`);
        if (coord) coord.textContent = `${(lm.x*100).toFixed(0)},${(lm.y*100).toFixed(0)}`;
    } else {
        hoveredIdx = null;
    }
});

function drawPoints(lms, W, H) {
    const jawline = [10,338,297,332,284,251,389,356,454,323,361,288,397,365,379,378,400,377,152,148,176,149,150,136,172,58,132,93,234,127,162,21,54,103,67,109];
    const cheekArea = [116,123,147,213,192,214,212,216,206,203,234,127,162,132,58,172,136,150,149,176,148,152];
    const keyIds = KEY_POINTS.map(p => p.id);

    lms.forEach((lm, i) => {
        const x = (1 - lm.x) * W;
        const y = lm.y * H;
        let show = false;
        let color = 'rgba(255,255,255,0.3)';
        let size = 2;

        if (mode === 'all') { show = true; }
        else if (mode === 'jaw' && jawline.includes(i)) { show = true; color = '#c9a84c'; size = 4; }
        else if (mode === 'cheek' && cheekArea.includes(i)) { show = true; color = '#3b82f6'; size = 4; }
        else if (mode === 'key' && keyIds.includes(i)) {
            show = true;
            const kp = KEY_POINTS.find(p => p.id === i);
            color = kp ? kp.color : '#fff';
            size = 5;
        }
        else if (mode === 'numbers') { show = true; size = 2; }

        if (!show) return;

        // Highlight hovered
        if (i === hoveredIdx) { color = '#ffff00'; size = 8; }
        if (i === highlightedPoint) { color = '#ff00ff'; size = 8; }

        ctx.save();
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.shadowColor = color;
        ctx.shadowBlur = i === hoveredIdx ? 12 : 4;
        ctx.fill();
        ctx.restore();

        // Show numbers in numbers mode or for key/hovered points
        if (mode === 'numbers' || i === hoveredIdx || (mode === 'key' && keyIds.includes(i))) {
            ctx.save();
            ctx.font = `bold ${mode === 'numbers' ? 8 : 11}px monospace`;
            ctx.fillStyle = i === hoveredIdx ? '#ffff00' : color;
            ctx.fillText(i, x + 5, y - 3);
            ctx.restore();
        }
    });
}

// ‚îÄ‚îÄ‚îÄ MediaPipe Setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const faceMesh = new FaceMesh({
    locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
});

faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
});

faceMesh.onResults(results => {
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0, 0, W, H);

    const found = results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0;
    document.getElementById('status').textContent = found ? '‚úì Face detected ‚Äî hover over points' : '‚ü≥ Looking for face...';
    document.getElementById('status').className = found ? 'found' : 'searching';

    if (found) {
        landmarks = results.multiFaceLandmarks[0];
        drawPoints(landmarks, W, H);

        // Update key point coords
        KEY_POINTS.forEach(kp => {
            const lm = landmarks[kp.id];
            const el = document.getElementById(`coord-${kp.id}`);
            if (el && lm) el.textContent = `${(lm.x*100).toFixed(0)},${(lm.y*100).toFixed(0)}`;
        });
    }
});

async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    video.srcObject = stream;
    await video.play();

    const detect = async () => {
        if (video.videoWidth > 0) await faceMesh.send({ image: video });
        requestAnimationFrame(detect);
    };
    detect();
}

populateKeyPoints();
startCamera();
</script>
</body>
</html>
